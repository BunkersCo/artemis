version: '3'
services:
  openbmp-collector:
    image: openbmp/collector:latest
    container_name: openbmp-collector
    depends_on:
      - openbmp-kafka
    restart: always
    networks:
      openbmp:
        ipv4_address: 20.0.0.100
    environment:
      KAFKA_FQDN: openbmp-kafka
    working_dir: /root
    entrypoint: ["sh", "-c"]
    command: ["wait-for openbmp-kafka:9092 -t 0 && sed -i \"s;-l /var/log/openbmpd.log;;\" /usr/sbin/run && /usr/sbin/run"]
    volumes:
      - ./scripts/wait-for:/usr/bin/wait-for
      - ./local_configs/openbmp/openbmpd.conf:/usr/etc/openbmp/openbmpd.conf
  openbmp-kafka:
    image: openbmp/kafka:latest
    container_name: openbmp-kafka
    restart: always
    privileged: true
    networks:
      openbmp:
    environment:
      KAFKA_FQDN: openbmp-kafka
  bgpstream:
    image: caida/bgpstream:latest
    container_name: bgpstream
    depends_on:
      - openbmp-kafka
      - openbmp-collector
    restart: always
    networks:
      openbmp:
    environment:
      KAFKA_HOST: ${KAFKA_HOST}
      KAFKA_PORT: ${KAFKA_PORT}
      KAFKA_TOPIC: ${KAFKA_TOPIC}
    working_dir: /root
    entrypoint: ["sh", "-c"]
#    command: ["wait-for ${KAFKA_HOST}:${KAFKA_PORT} -t 0 && bgpreader -d kafka -o brokers=${KAFKA_HOST}:${KAFKA_PORT} -o topic=${KAFKA_TOPIC} -l"]
    command: ["wait-for ${KAFKA_HOST}:${KAFKA_PORT} -t 0 && python3 -u pybgpstream.py"]
    volumes:
      - ./scripts/wait-for:/usr/bin/wait-for
      - ./scripts/pybgpstream.py:/root/pybgpstream.py
  r01:
    image: gobgp:latest
    build:
      dockerfile: Dockerfile
      context: .
    container_name: r01
    restart: always
    networks:
      openbmp:
      comm:
        ipv4_address: 1.1.1.2
    volumes:
      - ./local_configs/gobgp/r01.conf:/etc/gobgp/gobgp.conf
  r02:
    image: gobgp:latest
    build:
      dockerfile: Dockerfile
      context: .
    container_name: r02
    restart: always
    networks:
      openbmp:
      comm:
        ipv4_address: 1.1.1.3
    volumes:
      - ./local_configs/gobgp/r02.conf:/etc/gobgp/gobgp.conf
  r03:
    image: gobgp:latest
    build:
      dockerfile: Dockerfile
      context: .
    container_name: r03
    restart: always
    networks:
      openbmp:
      comm:
        ipv4_address: 1.1.1.4
    working_dir: /root
    entrypoint: ["./traffic.sh"]
    volumes:
      - ./local_configs/gobgp/r03.conf:/etc/gobgp/gobgp.conf
      - ./scripts/traffic.sh:/root/traffic.sh

networks:
  comm:
    ipam:
      driver: default
      config:
        - subnet: 1.1.1.0/24
  openbmp:
    ipam:
      driver: default
      config:
        - subnet: 20.0.0.0/24
