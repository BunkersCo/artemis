{% extends "layout.htm" %}

{% block head %}
    {{super()}}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='datatable/dataTables.bootstrap4.min.css') }}">
{% endblock %}

{% block page_content %}
    {{super()}}
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Dashboard</h1>
            </div>


            <div class="col-lg-8">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-bell fa-fw"></i> Activity
                        </div>
                        <div class="panel-body">
                            Welcome back <b>{{ current_user.email }}</b>, your last login was at <b id="last_login">
                            {% if current_user.last_login_at != None %}
                                {{ current_user.last_login_at.timestamp() }}
                            {% else %}
                                0
                            {% endif %}
                            </b> from {{ current_user.last_login_ip }}.
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-bell fa-fw"></i> Ongoing Hijacks
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-lg-12"> 
                                    <table class="table table-striped table-bordered" id="hijacks">
                                        <thead>
                                            <th>Time Detected</th>
                                            <th>Status</th>
                                            <th>Prefix</th>
                                            <th>Type</th>
                                            <th>Hijack AS</th>
                                            <th># Peers Seen</th>
                                            <th># ASes Infected</th>
                                            <th>Seen</th>
                                            <th>More</th>
                                        </thead>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        </hr>
                        <p class="float-right"><i>Times are shown in your local time zone <b id="timezone"></b>.</i></p>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div id="monitors">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-bell fa-fw"></i> System Status
                        </div>
                        <div class="panel-body">
                            <div class="list-group">
                                <ul>
                                    <li class="list-group-item">
                                        <div class="row">
                                            <div class="col-lg-4"><strong>Module</strong></div>
                                            <div class="col-lg-8">
                                                <div class="row">
                                                    <div class="col-lg-4"> <strong>Status</strong> </div>
                                                    <div class="col-lg-8"> <strong>Uptime</strong> </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {% for module in modules %}
                                    <li class="list-group-item">
                                        <div class="row">
                                            <div class="col-lg-4">{{ module }}</div>

                                            <div class="col-lg-8">{% if modules[module]['status'] == 'up': %}
                                                    <div class="row">
                                                        <div class="col-lg-4">
                                                             <b style="color:#008000">On</b>
                                                        </div> 
                                                        <div class="col-lg-8">
                                                            {{ modules[module]['uptime'] }}
                                                        </div>  
                                                    </div>
                                                {% else %}
                                                    <div class="row">
                                                        <div class="col-lg-4">
                                                            <b style="color:#ff0000">Off</b>
                                                        </div> 
                                                        <div class="col-lg-8">
                                                            {{ modules[module]['uptime'] }}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="systemstatus">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-bell fa-fw"></i> Statistics
                        </div>
                        <div class="panel-body">
                            <div class="list-group">
                                <ul>
                                    {% for stat in db_stats %}
                                    <li class="list-group-item"> 
                                        <div class="row">
                                            <div class="col-lg-7">{{ stat[0] }}:</div>


                                            <div class="col-lg-5">
                                                <b>{{ stat[1] }}</b>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    {% block scripts %}
        {{super()}}
        <script>
            var table;

            var columns = [
                { data: 'time_detected' },
                { data: 'prefix' },
                { data: 'type' },
                { data: 'hijack_as' },
                { data: 'num_peers_seen' },
                { data: 'num_asns_inf' }];

            function render_table(){
                var parameters = {};
                parameters['and'] = "(active.eq.true)";

                table = $('#hijacks').DataTable( {
                    "processing": true,
                    "serverSide": true,
                    "searching": false,
                    ajax: function(data, callback, settings) {
                        $.ajax({
                            type: "POST",
                            url: "https://128.110.154.184:8080/v1alpha1/graphql",
                            dataType: "json",
                            beforeSend: function(request) {
                                request.setRequestHeader("X-Hasura-Access-Key", "@rt3m1s.");
                                request.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                            },
                            data: JSON.stringify({
                                query: '{ view_hijacks_aggregate { aggregate { totalCount: count } } view_hijacks(limit: '+data.length+', offset: '+data.start+', order_by: {'+columns[data.order[0].column].data+': '+data.order[0].dir+'}) { time_detected prefix type hijack_as num_peers_seen num_asns_inf key seen withdrawn resolved ignored active } }'
                            }),
                            success: function(data, status, xhr){
                                callback({
                                    recordsTotal: data.data.view_hijacks_aggregate.aggregate.totalCount,
                                    recordsFiltered: data.data.view_hijacks_aggregate.aggregate.totalCount,
                                    data: data.data.view_hijacks
                                });
                            }
                        });
                    },
                    "order": [[ 0, "desc" ]],
                    "columns": [
                        { data: 'time_detected',
                            render: function(data, type, row){
                                return transform_date_to_local(data);
                            }
                        },
                        {
                            data: function( row, type, val, meta ) {
                                return format_hijack_status(row)
                            }
                        },
                        { data: 'prefix' },
                        { data: 'type' },
                        { data: 'hijack_as',
                            render: function(data, type, row){
                                return format_hijack_as(data)
                            }
                        },
                        { data: 'num_peers_seen' },
                        { data: 'num_asns_inf' },
                        {
                            data: 'seen',
                            render: function(data, type, row){
                                if(data == true){
                                    return '<img src=\"{{ url_for('static', filename='images/handled.png') }}\" />'
                                }else{
                                    return '<img src=\"{{ url_for('static', filename='images/unhadled.png') }}\"/>'
                                }
                            }
                        },
                        {
                            data: 'key',
                            render: function(data, type, row){
                                return '<a href="{{ url_for('main.display_hijack') }}?key=' + data + '">View</a>'
                            }
                        }
                    ],
                    "columnDefs": [ {
                        "targets": [1,7,8],
                        "orderable": false
                        }
                    ],
                    "language": {
                        "emptyTable": "<img src=\"{{ url_for('static', filename='images/checkmark.png') }}\" ></img></br><h3>No hijack alerts.</h3></br>"
                    }
                });
            }

            setInterval( function () {
                table.ajax.reload(null, false);
            }, 5000 );

            $(document).ready(function(){ 
                render_table({});
                $("#last_login").html("(" + transform_unix_timestamp_to_client_local_time($("#last_login").text()) + ")")
                $('#timezone').html(display_timezone());
            });

        </script>
        <script src="{{ url_for('static', filename='js/custom/utils.js') }}"></script>
        <script src="{{ url_for('static', filename='datatable/jquery.dataTables.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/moment-with-locales.min.js') }}"></script>
        <script src="{{ url_for('static', filename='datatable/datetime-moment.js') }}"></script>
        <script src="{{ url_for('static', filename='datatable/dataTables.bootstrap4.min.js') }}"></script>

    {% endblock %}
{% endblock %}
        
