{% extends "layout.htm" %}

{% block head %}
    {{super()}}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='datatable/dataTables.bootstrap4.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/daterangepicker.css') }}">

    
{% endblock %}

{% block page_content %}
    {{super()}}
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Hijacks</h1>
            </div>
        </div>

        <div class="row">

            <div class="col-lg-1 offset-lg-1">
                <p id="display_entries_time"> Select prefix: </p>
            </div>

            <div class="col-lg-2">
                <div class="form-group">
                    <select class="form-control" id="prefixes_selection">
                        <option>All</option>
                        {% for prefix in prefixes %}
                            <option>{{ prefix }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="col-lg-1 offset-lg-4">
                <p id="display_entries_time"> Timewindow: </p>
            </div>
            <div class="col-lg-3">
                
                <div id="timewindow_buttons">
                    <button type="button" id="select_timewindow_all" class="btn btn-outline-primary">All</button>
                    <button type="button" id="select_timewindow_1h" class="btn btn-outline-secondary">1h</button>
                    <button type="button" id="select_timewindow_24h" class="btn btn-outline-secondary">24h</button>
                    <button type="button" id="select_timewindow_48h" class="btn btn-outline-secondary">48h</button>
                    <button type="button" id="select_timewindow_other" class="btn btn-outline-secondary">Custom</button>
                </div>
                <div id="custom_time">
                    <div class="row">
                        <div class="col-lg-10">
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <input class="form-control" type="text" name="datetimes"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                
                <table class="table table-striped table-bordered" id="hijacks">
                    <thead>
                        <th>Time Detected</th>
                        <th>Status</th>
                        <th>Prefix</th>
                        <th>Type</th>
                        <th>Hijack AS</th>
                        <th># Peers Seen</th>
                        <th># ASes Infected</th>
                        <th>More</th>
                    </thead>
                </table>
                
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                </hr>
                <p> <i>
                    <a id="status_active_text" style="color:red" href="javascript:filter_by_status('active');">Ongoing</a> / 
                    <a id="status_resolved_text" style="color:green" href="javascript:filter_by_status('resolved');">Resolved</a> / 
                    <a id="status_ignored_text" style="color:orange" href="javascript:filter_by_status('ignored');">Ignored</a> / 
                    <a id="status_under_mitigation_text" style="color:blue" href="javascript:filter_by_status('under_mitigation');">Under Mitigation</a> </i></p>
            </div>
            <div class="col-lg-6">
                </hr>
                <p class="float-right"><i>Times are shown in your local time zone.</i></p>
            </div>
        </div>
    
{% endblock %}

{% block body %}
    {{super()}}
    {% block scripts %}
        {{super()}}
        <script>
            var table;
            var display_settings = { 'prefixes': null, 'time': null };
            var selected_status = null;
            $('#custom_time').hide();

            $('#select_timewindow_all').on('click', function(event) {
                $('#custom_time').hide();
                $('#timewindow_buttons').children().each(function () { $(this).attr('class', 'btn btn-outline-secondary'); });
                $(this).attr('class', 'btn btn-outline-primary');
                display_settings['time'] = null;
                $('#hijacks').DataTable().destroy();
                render_table(display_settings);
            });
            
            $('#select_timewindow_1h').on('click', function(event) {
                $('#custom_time').hide();
                $('#timewindow_buttons').children().each(function () { $(this).attr('class', 'btn btn-outline-secondary'); });
                $(this).attr('class', 'btn btn-outline-primary');
                var start_date = new Date();
                start_date.setHours(start_date.getHours() - 1);
                var end_date = new Date()
                display_settings['time'] = { 'start_time': start_date.toISOString(), 'end_time': end_date.toISOString() };
                $('#hijacks').DataTable().destroy();
                render_table(display_settings);
            });

            $('#select_timewindow_24h').on('click', function(event) {
                $('#custom_time').hide();
                $('#timewindow_buttons').children().each(function () { $(this).attr('class', 'btn btn-outline-secondary'); });
                $(this).attr('class', 'btn btn-outline-primary');
                var start_date = new Date();
                start_date.setHours(start_date.getHours() - 24);
                var end_date = new Date()
                display_settings['time'] = { 'start_time': start_date.toISOString(), 'end_time': end_date.toISOString() };
                $('#hijacks').DataTable().destroy()
                render_table(display_settings);
            });

            $('#select_timewindow_48h').on('click', function(event) {
                $('#custom_time').hide();
                $('#timewindow_buttons').children().each(function () { $(this).attr('class', 'btn btn-outline-secondary'); });
                $(this).attr('class', 'btn btn-outline-primary');
                var start_date = new Date();
                start_date.setHours(start_date.getHours() - 48);
                var end_date = new Date()
                display_settings['time'] = { 'start_time': start_date.toISOString(), 'end_time': end_date.toISOString() };
                $('#hijacks').DataTable().destroy()
                render_table(display_settings);
            });

            $('#select_timewindow_other').on('click', function(event) {
                $('#timewindow_buttons').children().each(function () { $(this).attr('class', 'btn btn-outline-secondary'); });
                $(this).attr('class', 'btn btn-outline-primary');
                $('#custom_time').show();                
            });

            $("#prefixes_selection").change(function () {
                var option = this.value;
                if(option == "All"){
                    display_settings['prefixes'] = null;
                }else{
                    display_settings['prefixes'] = option;
                }
                $('#hijacks').DataTable().destroy()
                render_table(display_settings);
            });

            function filter_by_status(status){
                // no status selected
                if(selected_status == status){
                    selected_status = status;
                    $("#status_" + status + "_text").css("font-weight", "");
                    delete display_settings['status'];
                }else{
                    selected_status = status;
                    var status_list = ['active', 'resolved', 'ignored', 'under_mitigation'];
                    var filtered_status_list = status_list.filter(function(e) { return e !== status })
                    $("#status_" + status + "_text").css("font-weight", "bold")
                    display_settings['status'] = status;
                    for (status_ in filtered_status_list){
                        $("#status_" + filtered_status_list[status_] + "_text").css("font-weight", "");
                    }
                }
                $('#hijacks').DataTable().destroy()
                render_table(display_settings);
            }

            
            var columns = [
                { data: 'time_detected' },
                { data: 'prefix' },
                { data: 'type' },
                { data: 'hijack_as' },
                { data: 'num_peers_seen' },
                { data: 'num_asns_inf' },
                { data: 'time_started' },
                { data: 'time_last' },
                { data: 'time_ended' },
                { data: 'mitigation_started'},
                { data: 'to_mitigate' }];

            function render_table(settings){
                var parameters = {};
                parameters['and'] = "(";

                if(settings['time'] != null){
                    parameters['and'] += 'time_started.gte.' + settings['time']['start_time'];
                    parameters['and'] += ',time_started.lte.' + settings['time']['end_time'];
                }

                if(settings['prefixes'] != null){
                   if(parameters['and'] != "("){
                        parameters['and'] += ","
                    }
                    parameters['and'] += "configured_prefix.eq." + settings['prefixes'];
                }

                if ('status' in settings){
                    if(parameters['and'] != "("){
                        parameters['and'] += ","
                    }
                    parameters['and'] += settings['status'] + ".eq.true";
                    if (settings['status'] == 'active'){
                        parameters['and'] += ',under_mitigation.eq.false'
                    }
                }

                if(parameters['and'] == '('){
                    delete parameters['and']
                }else{
                    parameters['and'] += ")"
                }

                table = $('#hijacks').DataTable( {
                    "processing": true,
                    "serverSide": true,
                    ajax: function(data, callback, settings) {
                        parameters['offset'] = data.start;
                        parameters['limit'] = data.length;
                        parameters['order'] =  columns[data.order[0].column].data + "." + data.order[0].dir;
                        $.ajax({
                            type: "POST",
                            url: '{{ url_for('proxy_api') }}',
                            dataType: "json",
                            dataType: "json",
                            data: { "action": "view_hijacks", "parameters" : JSON.stringify(parameters) },

                            success: function(data, status, xhr){
                                callback({
                                    recordsTotal: data.total,
                                    recordsFiltered: data.total,
                                    data: data.results
                                });
                            }
                        });
                    },
                    "order": [[ 0, "desc" ]],
                    "columns": [
                        { data: 'time_detected',
                            render: function(data, type, row){
                                return transform_date_to_local_(data);
                            }
                        },
                        {   
                            data: function( row, type, val, meta ) {
                                return hijack_status(row)
                            }
                        },
                        { data: 'prefix' },
                        { data: 'type' },
                        { data: 'hijack_as',
                            render: function(data, type, row){
                                return hijack_as_formmated(data)
                            } 
                        },
                        { data: 'num_peers_seen' },
                        { data: 'num_asns_inf' },
                        {
                            data: 'key',
                            render: function(data, type, row){
                                return '<a href="{{ url_for('main.display_hijack') }}?key=' + data + '">View</a>'
                            }
                        }
                    ],
                    "columnDefs": [ {
                        "targets": [1,8],
                        "orderable": false
                        } 
                    ],
                    "language": {
                        "emptyTable": "<img src=\"{{ url_for('static', filename='images/checkmark.png') }}\" ></img></br><h3>No hijack alerts. Go grab a beer!</h3></br>"
                    }
                });
            }
        
            setInterval( function () {
                table.ajax.reload(null, false);
            }, 5000 );
            
            function hijack_status(data){
                if(data['under_mitigation'] == true){
                    return '<b style="color:blue">Under Mitigation</b>'
                }else if(data['resolved'] == true){
                    return '<b style="color:green">Resolved</b>'
                }else if(data['active'] == true){
                    return '<b style="color:red">Ongoing</b>'
                }else if(data['ignored'] == true){
                    return '<b style="color:orange">Ignored</b>'
                }else{
                    return "Uknown"
                }
            }        
            
            $(document).ready(function(){
                render_table({})
                $('input[name="datetimes"]').daterangepicker({
                    timePicker: true,
                    startDate: moment().startOf('hour'),
                    endDate: moment().startOf('hour').add(32, 'hour'),
                    locale: {
                        format: 'M/DD hh:mm A'
                    }
                },  function(start, end, label) {
                    display_settings['time'] = { 'start_time': start.toISOString(), 'end_time': end.toISOString()};
                    $('#hijacks').DataTable().destroy()
                    render_table(display_settings);
                    }
                );

            });

            function transform_date_to_local_(date){
                var date_ = moment.utc(date)
                if(date_._isValid){
                    var local = date_.local().format('YYYY-MM-DD HH:mm:ss');
                    return local;
                }
                return "Never";
            }

        </script>
        <script src="{{ url_for('static', filename='js/custom/utils.js') }}"></script>    
        <script src="{{ url_for('static', filename='datatable/jquery.dataTables.min.js') }}"></script>
        <script src="{{ url_for('static', filename='datatable/jquery.dataTables.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/moment-with-locales.min.js') }}"></script>
        <script src="{{ url_for('static', filename='datatable/datetime-moment.js') }}"></script>
        <script src="{{ url_for('static', filename='datatable/dataTables.bootstrap4.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/daterangepicker.min.js') }}"></script>
    {% endblock %}
{% endblock %}
